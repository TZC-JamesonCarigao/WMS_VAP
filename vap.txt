#admin.py

from django.contrib import admin
from .models import VAPProductionData, Product, Source, ProductionDescription  # Changed import

class VAPProductionDataAdmin(admin.ModelAdmin):  # Renamed the admin class
    list_display = ('Date', 'PlantLoc', 'Shift', 'Product', 'TimeStart', 'TimeEnd', 'Total')
    list_filter = ('Date', 'PlantLoc', 'Shift', 'Product')
    search_fields = ('Product', 'ProdMinDescrip')
    # date_hierarchy = 'Date'
    ordering = ('-Date', '-TimeStart')

admin.site.register(VAPProductionData, VAPProductionDataAdmin)  # Updated registration
admin.site.register(Product)
admin.site.register(Source)
admin.site.register(ProductionDescription)

#forms.py
# WMSApp/forms.py
from django import forms
from django.core.exceptions import ValidationError
from .models import VAPProductionData, Product, Source, ProductionDescription  # Updated import
import datetime

class VAPProductionDataForm(forms.ModelForm):  # Renamed form class
    Total = forms.CharField(widget=forms.HiddenInput(), required=False)  # Updated field name
    
    class Meta:
        model = VAPProductionData  # Updated model reference
        fields = '__all__'
        widgets = {
            'Date': forms.DateInput(attrs={'type': 'date'}),  # Updated field name
            'TimeStart': forms.TimeInput(attrs={'type': 'time'}),  # Updated field name
            'TimeEnd': forms.TimeInput(attrs={'type': 'time'}),  # Updated field name
            'ProdMinDescrip': forms.Select(attrs={'class': 'form-control'}),  # Updated field name
            'Source': forms.Select(attrs={'class': 'form-control'}),  # Updated field name
            'Product': forms.Select(attrs={'class': 'form-control'}),  # Updated field name
        }
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        # Set default values
        self.fields['Date'].initial = datetime.date.today()  # Updated field name
        self.fields['PlantLoc'].initial = 'PULILAN'  # Updated field name
        self.fields['Shift'].initial = 'DAY SHIFT'  # Updated field name
        
    def clean(self):
        cleaned_data = super().clean()
        time_start = cleaned_data.get('TimeStart')  # Updated field name
        time_end = cleaned_data.get('TimeEnd')  # Updated field name
        
        if time_start and time_end:
            if time_start == time_end:
                raise ValidationError("Start time and end time cannot be the same")
            
            # Calculate total time and update the field
            record = VAPProductionData(  # Updated model reference
                TimeStart=time_start,  # Updated field name
                TimeEnd=time_end  # Updated field name
            )
            cleaned_data['Total'] = record.calculate_total_time()  # Updated field name
        
        return cleaned_data

class ImportForm(forms.Form):
    excel_file = forms.FileField(
        label='Select Excel file to import',
        help_text='The Excel file should match the export format'
    )

#models.py
from django.db import models

class Product(models.Model):
    name = models.CharField(max_length=100)
    
    def __str__(self):
        return self.name

class Source(models.Model):
    name = models.CharField(max_length=100)
    
    def __str__(self):
        return self.name

class ProductionDescription(models.Model):
    description = models.CharField(max_length=200)
    
    def __str__(self):
        return self.description

class VAPProductionData(models.Model):  # Changed model name to match table
    PLANT_CHOICES = [
        ('PULILAN', 'Pulilan'),
        ('TARLAC', 'Tarlac'),
    ]
    
    SHIFT_CHOICES = [
        ('DAY SHIFT', 'Day Shift'),
        ('NIGHT SHIFT', 'Night Shift'),
    ]
    
    ID = models.AutoField(primary_key=True)  # Added explicit ID field
    Date = models.CharField(max_length=255, db_column='Date')  # Changed to match DB column
    PlantLoc = models.CharField(max_length=255, choices=PLANT_CHOICES, null=True, db_column='PlantLoc')
    Shift = models.CharField(max_length=255, choices=SHIFT_CHOICES, null=True, db_column='Shift')
    Product = models.CharField(max_length=255, db_column='Product')
    TimeStart = models.CharField(max_length=255, db_column='TimeStart')
    TimeEnd = models.CharField(max_length=255, db_column='TimeEnd')
    Total = models.CharField(max_length=100, db_column='Total')  # Stored as "X hr YY min"
    ProdMinDescrip = models.CharField(max_length=255, null=True, db_column='ProdMinDescrip')
    BoilerTemp = models.IntegerField(db_column='BoilerTemp')
    CookingOilTemp = models.DecimalField(max_digits=5, decimal_places=2, db_column='CookingOilTemp')
    MetersPerMin = models.IntegerField(null=True, db_column='MetersPerMin')
    OutputTemp = models.DecimalField(max_digits=5, decimal_places=2, db_column='OutputTemp')
    InputTemp = models.DecimalField(max_digits=5, decimal_places=2, db_column='InputTemp')
    Source = models.CharField(max_length=255, null=True, db_column='Source')
    FormaticStrokeMin = models.IntegerField(db_column='FormaticStrokeMin')
    Section = models.CharField(max_length=255, null=True, db_column='Section')
    MonthYear = models.CharField(max_length=255, null=True, db_column='MonthYear')
    
    class Meta:
        db_table = 'VAPProductionData'  # Changed to match your SQL table name
        ordering = ['-Date', '-TimeStart']
    
    def __str__(self):
        return f"{self.Date} - {self.Shift} - {self.Product}"
    
    def save(self, *args, **kwargs):
        # Calculate total time before saving
        if self.TimeStart and self.TimeEnd:
            self.Total = self.calculate_total_time()
        super().save(*args, **kwargs)
    
    def calculate_total_time(self):
        """Calculate total time between start and end times"""
        MINUTES_PER_HOUR = 60
        HOURS_PER_DAY = 24
        
        start_h = self.TimeStart.hour
        start_m = self.TimeStart.minute
        end_h = self.TimeEnd.hour
        end_m = self.TimeEnd.minute
        
        start_total_minutes = start_h * MINUTES_PER_HOUR + start_m
        end_total_minutes = end_h * MINUTES_PER_HOUR + end_m
        
        total_minutes = end_total_minutes - start_total_minutes
        if total_minutes < 0:
            total_minutes += HOURS_PER_DAY * MINUTES_PER_HOUR
        
        display_hr = total_minutes // MINUTES_PER_HOUR
        display_min = total_minutes % MINUTES_PER_HOUR
        return f"{int(display_hr)} hr {int(display_min):02} min"

#views.py
from django.shortcuts import render, redirect, get_object_or_404
from django.views.generic import ListView, CreateView, UpdateView, DeleteView, FormView
from django.urls import reverse_lazy
from django.contrib import messages
from django.http import HttpResponse
from django.db.models import Sum, Count
from datetime import datetime, timedelta
import pandas as pd
import openpyxl
from openpyxl.utils.dataframe import dataframe_to_rows

from .models import VAPProductionData, Product, Source, ProductionDescription  # Updated import
from .forms import VAPProductionDataForm, ImportForm  # Note: You might want to rename this form too

from django.core.exceptions import FieldError

from copy import copy
from django.conf import settings
import os

from openpyxl import load_workbook


class ProductionRecordListView(ListView):
    model = VAPProductionData  # Updated model reference
    template_name = 'report_list.html'
    context_object_name = 'records'
    paginate_by = 20
    ordering = ['-Date', '-TimeStart']  # Updated field names

    def get_queryset(self):
        queryset = super().get_queryset()

        # Date range filtering
        start_date = self.request.GET.get('start_date')
        end_date = self.request.GET.get('end_date')

        if start_date and end_date:
            queryset = queryset.filter(Date__range=[start_date, end_date])  # Updated field name

        return queryset

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['start_date'] = self.request.GET.get('start_date', '')
        context['end_date'] = self.request.GET.get('end_date', '')
        return context


# class ProductionRecordCreateView(CreateView):
#     model = VAPProductionData  # Updated model reference
#     form_class = VAPProductionDataForm
#     template_name = 'create.html'
#     success_url = reverse_lazy('report_list')

#     def form_valid(self, form):
#         response = super().form_valid(form)
#         messages.success(self.request, 'Production record created successfully!')
#         return response

class ProductionRecordCreateView(CreateView):
    model = VAPProductionData
    form_class = VAPProductionDataForm
    template_name = 'create.html'
    success_url = reverse_lazy('report_list')

    def form_valid(self, form):
        response = super().form_valid(form)
        messages.success(self.request, 'Production record created successfully!')
        return response

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        # Add any additional context data if needed
        return context

class ProductionRecordUpdateView(UpdateView):
    model = VAPProductionData  # Updated model reference
    form_class = VAPProductionDataForm
    template_name = 'edit.html'
    success_url = reverse_lazy('report_list')

    def form_valid(self, form):
        response = super().form_valid(form)
        messages.success(self.request, 'Production record updated successfully!')
        return response


class ProductionRecordDeleteView(DeleteView):
    model = VAPProductionData  # Updated model reference
    template_name = 'delete.html'
    success_url = reverse_lazy('report_list')

    def delete(self, request, *args, **kwargs):
        response = super().delete(request, *args, **kwargs)
        messages.success(self.request, 'Production record deleted successfully!')
        return response


def dashboard_view(request):
    context = {
        'total_records': VAPProductionData.objects.count(),  # Updated model reference
        'recent_records': VAPProductionData.objects.order_by('-Date', '-TimeStart')[:10],  # Updated field names
    }

    try:
        product_distribution = (
            VAPProductionData.objects  # Updated model reference
            .values('Product')  # Updated field name
            .annotate(count=Count('id'), total=Sum('FormaticStrokeMin'))  # Updated field name
            .order_by('-total')
        )
        
        context['product_distribution'] = {
            'labels': [item['Product'] for item in product_distribution],  # Updated field name
            'values': [float(item['total']) for item in product_distribution]
        }
    except FieldError:
        context['product_distribution'] = {
            'labels': ['Unknown'],
            'values': [0]
        }

    context['trend_data'] = {
        'dates': [], 
        'values': []
    }
    
    return render(request, 'dashboard.html', context)

def export_to_excel(request):
    try:
        start_date = request.GET.get('start_date')
        end_date = request.GET.get('end_date')

        queryset = VAPProductionData.objects.all()
        if start_date:
            queryset = queryset.filter(Date__gte=start_date)
        if end_date:
            queryset = queryset.filter(Date__lte=end_date)

        records = queryset.values(
            'ID', 'Date', 'PlantLoc', 'Shift', 'Product', 'TimeStart', 'TimeEnd',
            'Total', 'ProdMinDescrip', 'BoilerTemp', 'CookingOilTemp',
            'OutputTemp', 'InputTemp', 'Source', 'FormaticStrokeMin'
        )

        df = pd.DataFrame.from_records(records)

        # Map display choices (correct field names)
        df['PlantLoc'] = df['PlantLoc'].map(dict(VAPProductionData.PLANT_CHOICES))
        df['Shift'] = df['Shift'].map(dict(VAPProductionData.SHIFT_CHOICES))

        # ==== Utility Functions for Processing ====

        def convert_time_to_decimal(value):
            if isinstance(value, str) and ('hr' in value or 'min' in value):
                hours = 0
                minutes = 0
                if 'hr' in value:
                    parts = value.split('hr')
                    hours = int(parts[0].strip())
                    if 'min' in parts[1]:
                        minutes = int(parts[1].replace('min', '').strip())
                elif 'min' in value:
                    minutes = int(value.replace('min', '').strip())
                return round(hours + (minutes / 60), 2)
            return value

        def format_time(value):
            if pd.notna(value):
                try:
                    value = str(value)
                    parts = value.split(':')
                    if len(parts) >= 2:
                        hour = parts[0].zfill(2)
                        minute = parts[1].zfill(2)
                        return f"{hour}:{minute}"
                except:
                    pass
            return value

        def process_value(value):
            new_value = convert_time_to_decimal(value)
            if new_value == value:
                new_value = format_time(value)
            try:
                if isinstance(new_value, (int, float)):
                    return format(round(float(new_value), 2), '.2f')
                if isinstance(new_value, str) and new_value.replace('.', '', 1).isdigit():
                    return format(round(float(new_value), 2), '.2f')
            except:
                pass
            return new_value

        df = df.applymap(process_value)

        # === Excel template setup ===
        template_path = os.path.join(settings.BASE_DIR, 'templates', 'template.xlsx')
        wb = load_workbook(template_path)
        ws = wb.active
        start_row = 2
        start_col = 1
        template_row = ws[start_row]

        # Write data into Excel with style
        for r_idx, row in enumerate(dataframe_to_rows(df, index=False, header=False), start=start_row):
            for c_idx, value in enumerate(row, start=start_col):
                cell = ws.cell(row=r_idx, column=c_idx, value=value)
                template_cell = template_row[c_idx - start_col]
                if template_cell.has_style:
                    cell.font = copy(template_cell.font)
                    cell.border = copy(template_cell.border)
                    cell.fill = copy(template_cell.fill)
                    cell.number_format = copy(template_cell.number_format)
                    cell.protection = copy(template_cell.protection)
                    cell.alignment = copy(template_cell.alignment)

        # Filename for export
        if start_date or end_date:
            file_name = f"{start_date or 'start'}_to_{end_date or 'end'}.xlsx"
        else:
            file_name = "alldata.xlsx"

        # Return Excel file as HTTP response
        response = HttpResponse(content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
        response['Content-Disposition'] = f'attachment; filename={file_name}'
        wb.save(response)
        return response

    except Exception as e:
        return HttpResponse(f"Export failed: {str(e)}", status=500)

class ImportDataView(FormView):
    template_name = 'import.html'
    form_class = ImportForm
    success_url = reverse_lazy('report_list')

    def form_valid(self, form):
        excel_file = form.cleaned_data['excel_file']

        try:
            df = pd.read_excel(excel_file)

            for _, row in df.iterrows():
                VAPProductionData.objects.create(  # Updated model reference
                    Date=row['Date'],  # Updated field name
                    PlantLoc=row['Plant Location'],  # Updated field name
                    Shift=row['Shift'],  # Updated field name
                    Product=row['Product'],  # Updated field name (direct assignment now)
                    TimeStart=row['Start Time'],  # Updated field name
                    TimeEnd=row['End Time'],  # Updated field name
                    BoilerTemp=row['Boiler Temp (°C)'],  # Updated field name
                    CookingOilTemp=row['Oil Temp (°C)'],  # Updated field name
                    OutputTemp=row['Output Temp (°C)'],  # Updated field name
                    InputTemp=row['Input Temp (°C)'],  # Updated field name
                    Source=row['Source'],  # Updated field name (direct assignment now)
                    FormaticStrokeMin=row['Formatic Strokes/Min'],  # Updated field name
                    ProdMinDescrip=row['Description']  # Updated field name (direct assignment now)
                )

            messages.success(self.request, 'Data imported successfully!')
        except Exception as e:
            messages.error(self.request, f'Error importing data: {str(e)}')

        return super().form_valid(form)

#create.html
{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header py-3">
            <h5 class="m-0 text-primary fw-bold">Create Production Record</h5>
        </div>
        <div class="card-body">
            <form method="post" novalidate>
                {% csrf_token %}
                
                <!-- Date and Plant -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="{{ form.Date.id_for_label }}" class="form-label">{{ form.Date.label }}</label>
                        {{ form.Date|add_class:"form-control" }}
                        {% for error in form.Date.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.PlantLoc.id_for_label }}" class="form-label">{{ form.PlantLoc.label }}</label>
                        {{ form.PlantLoc|add_class:"form-control" }}
                        {% for error in form.PlantLoc.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Shift and Product -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="{{ form.Shift.id_for_label }}" class="form-label">{{ form.Shift.label }}</label>
                        {{ form.Shift|add_class:"form-control" }}
                        {% for error in form.Shift.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.Product.id_for_label }}" class="form-label">{{ form.Product.label }}</label>
                        {{ form.Product|add_class:"form-control" }}
                        {% for error in form.Product.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Time Start / End -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="{{ form.TimeStart.id_for_label }}" class="form-label">{{ form.TimeStart.label }}</label>
                        {{ form.TimeStart|add_class:"form-control" }}
                        {% for error in form.TimeStart.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.TimeEnd.id_for_label }}" class="form-label">{{ form.TimeEnd.label }}</label>
                        {{ form.TimeEnd|add_class:"form-control" }}
                        {% for error in form.TimeEnd.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Total Time (auto-calculated) -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Calculated Total Time</label>
                        <div id="total-display" class="form-control bg-light">
                            -- hr -- min
                        </div>
                        {{ form.Total }}
                    </div>
                </div>

                <!-- Temperature Inputs -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="{{ form.BoilerTemp.id_for_label }}" class="form-label">{{ form.BoilerTemp.label }}</label>
                        {{ form.BoilerTemp|add_class:"form-control" }}
                        {% for error in form.BoilerTemp.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.CookingOilTemp.id_for_label }}" class="form-label">{{ form.CookingOilTemp.label }}</label>
                        {{ form.CookingOilTemp|add_class:"form-control" }}
                        {% for error in form.CookingOilTemp.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="{{ form.OutputTemp.id_for_label }}" class="form-label">{{ form.OutputTemp.label }}</label>
                        {{ form.OutputTemp|add_class:"form-control" }}
                        {% for error in form.OutputTemp.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.InputTemp.id_for_label }}" class="form-label">{{ form.InputTemp.label }}</label>
                        {{ form.InputTemp|add_class:"form-control" }}
                        {% for error in form.InputTemp.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Source and Stroke -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="{{ form.Source.id_for_label }}" class="form-label">{{ form.Source.label }}</label>
                        {{ form.Source|add_class:"form-control" }}
                        {% for error in form.Source.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.FormaticStrokeMin.id_for_label }}" class="form-label">{{ form.FormaticStrokeMin.label }}</label>
                        {{ form.FormaticStrokeMin|add_class:"form-control" }}
                        {% for error in form.FormaticStrokeMin.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Description -->
                <div class="mb-3">
                    <label for="{{ form.ProdMinDescrip.id_for_label }}" class="form-label">{{ form.ProdMinDescrip.label }}</label>
                        {{ form.ProdMinDescrip|add_class:"form-control" }}
                        {% for error in form.ProdMinDescrip.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                </div>

                <!-- Buttons -->
                <div class="d-flex justify-content-end gap-2 mt-4">
                    <a href="{% url 'dashboard' %}" class="btn btn-secondary">Cancel</a>
                    <button type="submit" class="btn btn-primary">Create Record</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function calculateTotalTime() {
    const start = document.getElementById('id_TimeStart').value;
    const end = document.getElementById('id_TimeEnd').value;

    if (start && end) {
        const [sh, sm] = start.split(':').map(Number);
        const [eh, em] = end.split(':').map(Number);

        let total = (eh * 60 + em) - (sh * 60 + sm);
        if (total < 0) total += 24 * 60;

        const hours = Math.floor(total / 60);
        const mins = total % 60;

        document.getElementById('total-display').textContent = `${hours} hr ${mins.toString().padStart(2, '0')} min`;
        document.getElementById('id_Total').value = `${hours} hr ${mins.toString().padStart(2, '0')} min`;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('id_TimeStart').addEventListener('change', calculateTotalTime);
    document.getElementById('id_TimeEnd').addEventListener('change', calculateTotalTime);
    calculateTotalTime();
});
</script>
{% endblock %}